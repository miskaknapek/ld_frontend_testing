<!DOCTYPE html>
<html>
<head>
    <title>Simple Leaflet Map</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"
    />
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <style type="text/css">

        #map{
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .leaflet-control{
            top: 50px !important;
        }

        body{
            font-family: sans-serif;
            font-size: 1em;
            color: rgb( 0,0,12);
        }

        #time_marker_box_outer_outer{
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;     
            position: relative;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 50px;
            border: 1px solid rgb( 255, 255, 128, 0.5 );
            background-color: rgba(255,255,255,0.75);
        }

        #time_marker_box__central_element{
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;     
            position: absolute;
            float: left;
            top: 5px;
            left: 35%;
            right: 35%;
            width: 30%;
            height: 20px;
            border: 1px dashed orange;
            text-align: center;
        }

        #time_marker_box__left_element{
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;     
            position: absolute;
            float: left;
            top: 5px;
            left: 10px;
            width auto;
            height: 20px;
            opacity: 0.5;
            border: 1px dashed orange;
        }

        #time_marker_box__right_element{
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;     
            position: absolute;
            float: left;
            top: 5px;
            right: 10px;
            width: auto;
            height: 20px;
            opacity: 0.5;
            border: 1px dashed orange;
        }


        /* leaflet matter */
        img.leaflet-tile{             
            filter: grayscale(85%) saturate(150%) hue-rotate(60deg) contrast(90%) brightness(110%) !important;
        }

        /* -- svg tricks -- */

        circle{
            /*mix-blend-mode: soft-light;*/
        }
        


    </style>
</head>
<body>

    <div id="map"></div>

    <div id="time_marker_box_outer_outer">
        <div id="time_marker_box__left_element">/ / / /  </div>
        <div id="time_marker_box__central_element">LOADING DATA - PLEASE WAIT ;) </div>        
        <div id="time_marker_box__right_element">/ / / / /</div>
    </div>



    <script>

        
        var positions = [];

        var markers = [];


        // --------------------------------  


        ///////// BIG SWITCHES

        var load_data = false;




        ///////// PARAMETERS 



        // --- data / objects     


        // - data url formating

        var data_url__filename_beginning = "24_hrs_pm_data__starting_from__";
        var data_url__filename_end = ".json";

        var data_sample_rates = [ "180", "360", "900", "1800" ];
        var curr_data_time_interval = "180";

        var base_urls_to_data__at_different_intervals = {};

        base_urls_to_data__at_different_intervals[ "180" ] = 
        "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/tabular_ld_data__180_s_intervals/";



        // what's currently used 
        var base_url_to_data = base_urls_to_data__at_different_intervals[ "180" ];

        // this is where the days' worth of data live
        // - each object is one day's data, 
        //  and the key to each object is a hash - eg 2019.01.03 -> 2019-1-3 
        var days_data = { };


        // --- which is the current date

        var current_dateTime__as_Date_obj = new Date();


        // --- physical values related

        // Max PM val - this is when the colour gets near white.        
        window.max_pm_value = 50;



        // --- colour scale 

        var options = {
            // radius: 25,
            opacity: 0.6,
            duration: 200,
            valueDomain: [ 20, 40, 60, 100, 500],
            colorRange: [ '#00796B', '#F9A825', '#E65100', '#DD2C00', '#960084']
        };

        // initialise the colour scale! 
        var _colorScale = d3.scale.linear()
            .domain( options.valueDomain )
            .range( options.colorRange )
            .clamp(true);

    

        ////////// METHODS 

        var select_div_elements = function(){

            console.log(">>> select_div_elements() ");

            window.time_marker_box_outer_outer = document.getElementById("time_marker_box_outer_outer");
            window.time_marker_box__central_element = document.getElementById("time_marker_box__central_element");
            window.time_marker_box__left_element = document.getElementById("time_marker_box__left_element");
            window.time_marker_box__right_element = document.getElementById("time_marker_box__right_element");

        }


        var set_start_and_end_time__on_screen__according_to_data = function(){

            console.log(">>>> set_start_and_end_time__on_screen__according_to_data() ");

            window.time_marker_box__left_element.innerHTML = window.data2.data_time_period_start;
            window.time_marker_box__right_element.innerHTML = window.data2.data_time_period_end;

        }


        var make_all_timestamps = function(){

            console.log( ">>> make_all_timestamps() - ideally they should range from "+window.data2.data_time_period_start+" - "+window.data2.data_time_period_end );     

            // debug 
            console.log("--- num of values per sensor : "+window.num_of_data_values_per_sensor );

            // make a date object for beginning with 
            var start_time_as_date_obj = new Date( window.data2.data_time_period_start );

            // make out object - it's one item shorter, as we've already got the start time in there
            window.all_timestamps_in_data = [ window.data2.data_time_period_start ];            

            for( var i = 0; i < window.num_of_data_values_per_sensor; i++ ){

                var time_in_s = start_time_as_date_obj.setSeconds( start_time_as_date_obj.getSeconds() + window.data2.individual_data_sample_length_in_seconds );

                window.all_timestamps_in_data.push( new Date( time_in_s )  );
            }

            console.log( "---- ok! done making "+window.num_of_data_values_per_sensor+" new dates. with start date of "+window.all_timestamps_in_data[0]+" and end date of "+window.all_timestamps_in_data[ window.all_timestamps_in_data.length-1 ] );
            console.log("\t ---- got times array of length "+window.all_timestamps_in_data.length  );
        }

        // MAX PM VAL! 
        // MAX PM VAL! 
        // MAX PM VAL! 
        //
        // use this to calculate the visualistaion of pm values 
        // 

        // test updating the circles 
        var random_blink = function( interval_in_ms ){

            window.setInterval( function(){

                //  console.log("blinking at time "+( new Date() ) );

                window.feature.style("opacity", function(){

                    return Math.random() ;
                });

            }, interval_in_ms  );
        }




        // // //  playback over time :) 

        var playback_time_data_at_given_time_interval = function( interval_in_ms, advance_how_many_frames_per_frame_update ){

            console.log(">>>> playback_time_data_at_given_time_interval() ");

            window.counter = 0 ;

            window.playback_setInterval_instance_id  = window.setInterval( function(){

                console.log("--- playing back time countr i "+window.counter );

                test_draw_from_time_data( window.counter )

                window.counter += advance_how_many_frames_per_frame_update;

                // cancel the playback if we've played more frames than in the data
                if(  window.counter > window.num_of_data_values_per_sensor ){
                    console.log("--- ending playback! ");
                    clearInterval( window.playback_setInterval_instance_id );
                }

            }, interval_in_ms )
        }




        // load the new data - WITH TIME! 
        //
        var load_new_time_data = function(){

            console.log(">>>> load_new_time_data() - master data loading switch === |"+String( load_data ).toUpperCase()+"|");

            if( load_data ){
                // var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/latest_data_since_midnight__20190322_17something.json";
                // var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/24_hrs_pm_data__starting_from__2019-1-9.json";
                // var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/tabular_ld_data__180_s_intervals/24_hrs_pm_data__starting_from__2019-3-22.json"
                // save as window.data2 
                // var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/24_hrs_pm_data__starting_from__2019-3-1__2019-3-8.json"
                // var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/24_hrs_pm_data__starting_from__2019-3-1__2019-3-24.json"
                // var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/24_hrs_pm_data__starting_from__2019-2-25__2019-3-15.json";
                // var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/tabular_ld_data__180_s_intervals/24_hrs_pm_data__starting_from__2019-3-22.json";
                var url = "http://sourisr.kapsi.fi/luftdaten/luftDaten_data_explorations/ld_daten_various/24_hrs_pm_data__starting_from__2019-3-1__2019-3-2.json";
                // fetch js, good boy! 
                fetch( url )
                    .then( function( resp ){ return resp.json() })
                    .then( function(resp2){ 
                        // store data                 
                        window.data2 = resp2; 
                        // feedback
                        console.log("--- got data! width "+window.data2.data__p1_values.length+" sensors! - each with a length of "+window.data2.data__p1_values[0].length ); 
                        // next step
                        test_new__PART_TWO(); 
                    }) ;

            }

        }



        // parse the data 
        //
        // - make it d3 friendly, with one line per sensor
        var parse_data_into_something_d3_friendly = function(){

            console.log(">>>> parse_data_into_something_d3_friendly() - got data with "+window.data2.data__p1_values.length+" sensors, each of length "+window.data2.data__p1_values[0].length );

            var starttime = new Date();

            // window.data3 = [];

            window.num_of_sensors = window.data2.data__p1_values.length;
            window.num_of_data_values_per_sensor = window.data2.data__p1_values[0].length;

            window.parsed_data = new Array( window.num_of_sensors );

            // go per sensor 
            for( var sensor_id_i = 0; sensor_id_i < window.num_of_sensors; sensor_id_i++ ){

                // start making the current line 
                // - make it according to one sensor 
                window.parsed_data[ sensor_id_i ] = { sensor_id : window.data2.sensor_ids[ sensor_id_i ], latlon : window.data2.lat_lon[ sensor_id_i ], p1_data : window.data2.data__p1_values[ sensor_id_i ], p2_data : window.data2.data__p2_values[ sensor_id_i ]  };

            }

            console.log("--- done parsing sensor data in "+( new Date() - starttime )+" seconds ");

        }



        /////// remove the current markers

        var remove_current_markers = function(){

            console.log(">>>> remove_current_markers () ");

            window.feature.remove()
        }



        ////// the new position markers :) 

        var position_markers_on_map__after_map_move__WITH_D3__NEW_NEW = function(){

            console.log(">>>> position_markers_on_map__after_map_move__WITH_D3__NEW_NEW() ");

            window.feature = window.g.selectAll("circle")
                                .data( window.parsed_data )
                                    .enter()  
                                    .append( "circle" )
                                    // .style( "stroke", "rgba(255, 255, 128, 0.2 )" )
                                    .style( "stroke", "none" )
                                    // .style( "stroke-width", 1.5 )
                                    // .style( "fill", "yellow" )
                                    .style( "opacity", options.opacity )
                                    // .style( "opacity", 1 )
                                    // .style( "fill", "rgba( 255,255,255,0.1)" )
                                    .attr("r", 4 );                                    

            //// register event handlers on map move 
            map.on("viewreset", update_d3_layer__NEW_NEW );
            // and do a quick update for the first viewing… 
            update_d3_layer__NEW_NEW();                                        

        }



        ////// the new draw 

        var update_d3_layer__NEW_NEW = function(){

            console.log(">>>> update_d3_layer__NEW_NEW() ");

            window.feature.attr( "transform", function(d){
                var loc = [ d.latlon[0], d.latlon[1] ];
                var lat_to_px = map.latLngToLayerPoint( loc ).x;
                var lng_to_px = map.latLngToLayerPoint( loc ).y ;
                return "translate("+lat_to_px+","+lng_to_px+")";
            });

            console.log("--- map zoom level : "+map.getZoom() );
        }




        ////// test draw from time data index 

        var test_draw_from_time_data = function( time_index_as_i ){

            console.log(">>>> test_draw_from_time_data() of index |"+time_index_as_i );

            window.feature.style("fill", function(d,i){

        /*
                // 50 = safety limit
                // // 10 = to make it a decimal 
                var new_opacity_val = ( d.p1_data[ time_index_as_i ]/window.max_pm_value );

                // - adding some offsets due to the background colour of the map … 
                var grey_fill_val = Math.floor( new_opacity_val * 292 ) +58 ; 

                // only give feedback for the first 20 values :) 
                if( i < 1 ){ 
                    console.log( i+" : got in value "+d.p1_data[ time_index_as_i ]+" and got out value : "+new_opacity_val );
                }

                // return "rgba( 255, 255, 128, "+new_opacity_val+")" ;

                return "rgb("+grey_fill_val+","+grey_fill_val+","+(grey_fill_val/4)+")";
        */
                var curr_data_val = d.p1_data[ time_index_as_i ];

                // Colours : different handling of zero values 
                // quick check for zero values
                // - replace a zero value's colour with none…  
                if( curr_data_val === 0 ){
                    return "none";
                }else{ 
                    return _colorScale( curr_data_val );
                }
            
                // - DISABLED : the normal version, using only the colour scale
                //              - but which renders zero values black
                // return _colorScale( curr_data_val );

            });          


            // and update the time indication ( up in the middle of the window, in text )
            window.time_marker_box__central_element.innerHTML = window.all_timestamps_in_data[ time_index_as_i ];

        }




        ///////// bind mouse move listener to winodw

        var bind_mouseove_listener = function(){

            console.log(">>>> bind_mouseove_listener() ");

            window.addEventListener( "mousemove", function( event ){
                     window.mouseX = event.pageX; 
                     window.mouseY = event.pageY;
                    //
                     console.log("--- mouseX / mouseY : "+window.mouseX+","+window.mouseY );

                     // get the decimal positions of the mouse vs screen size 
                     window.mouseX_vs_screen_w_decimal = window.mouseX / window.innerWidth;
                     window.mouseY_vs_screen_w_decimal = window.mouseY / window.innerHeight;
                     //
                     console.log("--- mouseX/Y decimals vs screen w/h : "+window.mouseX_vs_screen_w_decimal+","+window.mouseY_vs_screen_w_decimal );

                     // now redraw with the relevant time :) 
                     var current_index = Math.floor( window.mouseX_vs_screen_w_decimal * window.num_of_data_values_per_sensor ) ;
                     console.log(" - current data index : "+current_index+" / "+window.num_of_data_values_per_sensor );

                     // now redraw
                     test_draw_from_time_data( current_index );

                  }, false );
        }



        ////// VERSION v2 things : 


        // // - check if a particular days' data is available, and load it, 
        //      - and possibly set up interface according to data, 
        //          when the data is loaded 

        var check_if_date_available = function( date_to_check, load_new_data_if_date_not_avail, set_interface_to_new_data_if_data_already_avail ){

            console.log(">>>> check_if_date_available() - load_new_data_if_date_not_avail : |"+load_new_data_if_date_not_avail+"|");


            // get date as string - can be useful as a key for the day data objects array             
            // - input : date object 
            var day_as_string = generate_date_as_year_month_day_string( date_to_check )

            // check that day data array for date
            if( days_data[ day_as_string ] ){

                // DATA EXISTS! 
                // - go ahead and SETUP INTERFACE ACCORDING TO THE DATA …
            }else{

                // DATA DOESN'T EXIST
                // - NEEDS LOADING ETC … 
            }


            //         
        }



        // // - load a given day's data, 
        //      - set up interface according to data,if relevant 
        //          when the data is loaded 

        var load_days_data__and_setup_as_appropriate = function( days_date_to_load, set_interface_to_new_data_if_data_already_avail ){

            console.log(">>>> load_days_data__and_setup_as_appropriate() - load_new_data_if_date_not_avail : |"+load_new_data_if_date_not_avail+"|   set_interface_to_new_data_if_data_already_avail : |"+set_interface_to_new_data_if_data_already_avail+"|");
        }


        // // - generate a valid url based on the givne date object 
        //

        var generate_url_for_data_from_date_object = function( in_date_object ){

            console.log(">>>> generate_url_for_data_from_date_object : generateing url from date obejct : |"+in_date_object+"|");

            // - build url 
            out_url = base_urls_to_data__at_different_intervals[ curr_data_time_interval ]+data_url__filename_beginning+generate_date_as_year_month_day_string( in_date_object )+data_url__filename_end;

            console.log("--- generated url |"+out_url+" from input date |"+in_date_object+"|");

            return out_url;
        }


        var generate_date_as_year_month_day_string = function( in_date ){

            console.log(">>>> generate_date_as_year_month_day_string() of in_date : |"+in_date+"|" );

               // - fetch consitutent parts of a date 
            var year_in_input = in_date_object.getFullYear();
            var month_in_input = in_date_object.getMonth();
            var day_in_input = in_date_object.getDay();

            // - build url 
            date_as_year_month_day_string = month_in_input+"-"+day_in_input+data_url__filename_end;

            console.log("--- got date string : |"+date_as_year_month_day_string+"| from input date |"+in_date+"|" );

            return date_as_year_month_day_string;                     
        }


        ///////////////////////////////////////////////////////////
        // // // // // // // // // // // // // // // // // // // // 
        // // // //                         // // // // // // // // 
        // // // //        the new main….   // // // // // // // // 

        var test_new = function(){

            console.log(">>>> test_new() \n" );

            // basic html things 
            select_div_elements();

            //
            load_new_time_data();

            // parse_data_into_something_d3_friendly();

        }



        ////// part 2 

        var test_new__PART_TWO = function(){

            console.log(">>>> test_new__PART_TWO() \n" );

            //
            parse_data_into_something_d3_friendly();

            //
            position_markers_on_map__after_map_move__WITH_D3__NEW_NEW();

            // find all the timestamps
            make_all_timestamps();

           // set start and end times on screen
            set_start_and_end_time__on_screen__according_to_data();

            //
            bind_mouseove_listener();


            // draw the first frame! 
            test_draw_from_time_data( 0 );
        }



        ////////////////////   STARTUP !   //////////////////
        ////////////////////   STARTUP !   //////////////////
        ////////////////////   STARTUP !   //////////////////
        ////////////////////   STARTUP !   //////////////////


        // make map 
        // make map 
        // make map 
        // make map 


        var map = L.map('map').setView([51.21909462044748, 10.328125], 6);
        mapLink = 
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer(
            /* 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'*/ /* 'http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png'*/ 'https://maps.luftdaten.info/tiles/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 18,
            }).addTo(map);

        map._initPathRoot();

        // add the d3 layer in the leaflet map… where the d3 content will be… 
        window.svg = d3.select("#map").select("svg");
        window.g = window.svg.append("g");
        

        // GO! 
        test_new();







    </script>
</body>
</html>
